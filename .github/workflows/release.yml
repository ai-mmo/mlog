name: Auto Release

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œç”¨äºç‰ˆæœ¬æ¯”è¾ƒ
          
      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true
          
      - name: é…ç½® Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦å‘å¸ƒ
        id: check_release
        run: |
          # è·å–æœ€æ–°çš„ commit ä¿¡æ¯
          COMMIT_MSG=$(git log -1 --pretty=%B)
          
          # æ£€æŸ¥ commit ä¿¡æ¯ä¸­æ˜¯å¦åŒ…å« [skip release] æˆ– [no release]
          if echo "$COMMIT_MSG" | grep -qiE '\[(skip|no)[ -]?release\]'; then
            echo "è·³è¿‡å‘å¸ƒï¼šcommit ä¿¡æ¯åŒ…å«è·³è¿‡æ ‡è®°"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºç‰ˆæœ¬æäº¤ï¼ˆé¿å…é‡å¤å‘å¸ƒï¼‰
          if echo "$COMMIT_MSG" | grep -qE '^chore: bump version to v[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "è·³è¿‡å‘å¸ƒï¼šè¿™æ˜¯ä¸€ä¸ªç‰ˆæœ¬æäº¤"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "should_release=true" >> $GITHUB_OUTPUT
          
      - name: ç¡®å®šç‰ˆæœ¬ç±»å‹
        id: version_type
        if: steps.check_release.outputs.should_release == 'true'
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          
          # æ ¹æ® commit ä¿¡æ¯ç¡®å®šç‰ˆæœ¬ç±»å‹
          if echo "$COMMIT_MSG" | grep -qiE '^(feat|feature)(\(.*\))?!:|^BREAKING CHANGE:|breaking change'; then
            echo "type=major" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°é‡å¤§æ›´æ–°ï¼Œå°†é€’å¢ä¸»ç‰ˆæœ¬å·"
          elif echo "$COMMIT_MSG" | grep -qiE '^(feat|feature)(\(.*\))?:'; then
            echo "type=minor" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°æ–°åŠŸèƒ½ï¼Œå°†é€’å¢æ¬¡ç‰ˆæœ¬å·"
          else
            echo "type=init" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°ä¿®å¤æˆ–å…¶ä»–æ›´æ”¹ï¼Œå°†é€’å¢è¡¥ä¸ç‰ˆæœ¬å·"
          fi
          
      - name: è¿è¡Œæµ‹è¯•
        if: steps.check_release.outputs.should_release == 'true'
        run: |
          if find . -name "*_test.go" -type f | grep -q .; then
            echo "è¿è¡Œæµ‹è¯•..."
            go test -v ./...
          else
            echo "æœªå‘ç°æµ‹è¯•æ–‡ä»¶ï¼Œè·³è¿‡æµ‹è¯•"
          fi
          
      - name: ä»£ç æ ¼å¼æ£€æŸ¥
        if: steps.check_release.outputs.should_release == 'true'
        run: |
          # æ£€æŸ¥ä»£ç æ ¼å¼
          unformatted=$(gofmt -l .)
          if [ -n "$unformatted" ]; then
            echo "å‘ç°æ ¼å¼ä¸è§„èŒƒçš„æ–‡ä»¶ï¼Œæ­£åœ¨æ ¼å¼åŒ–..."
            echo "$unformatted"
            go fmt ./...
            git add .
            git commit -m "style: è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç  [skip ci]" || true
          fi
          
          # è¿è¡Œ go vet
          go vet ./...
          
      - name: è®¡ç®—æ–°ç‰ˆæœ¬å·
        id: new_version
        if: steps.check_release.outputs.should_release == 'true'
        run: |
          # è·å–æœ€æ–°ç‰ˆæœ¬
          LATEST_VERSION=$(git tag -l | grep "^v" | sort -V | tail -1)
          
          if [ -z "$LATEST_VERSION" ]; then
            # é¦–æ¬¡å‘å¸ƒ
            case "${{ steps.version_type.outputs.type }}" in
              "major")
                NEW_VERSION="v1.0.0"
                ;;
              "minor")
                NEW_VERSION="v0.1.0"
                ;;
              *)
                NEW_VERSION="v0.0.1"
                ;;
            esac
          else
            # é€’å¢ç‰ˆæœ¬å·
            VERSION_WITHOUT_V=${LATEST_VERSION#v}
            IFS='.' read -ra PARTS <<< "$VERSION_WITHOUT_V"
            MAJOR=${PARTS[0]}
            MINOR=${PARTS[1]}
            PATCH=${PARTS[2]}
            
            case "${{ steps.version_type.outputs.type }}" in
              "major")
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              "minor")
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              *)
                PATCH=$((PATCH + 1))
                ;;
            esac
            
            NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          fi
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "æ–°ç‰ˆæœ¬å·: $NEW_VERSION"
          
      - name: æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
        if: steps.check_release.outputs.should_release == 'true'
        run: |
          VERSION="${{ steps.new_version.outputs.version }}"
          VERSION_WITHOUT_V=${VERSION#v}
          MODULE_NAME=$(grep "^module " go.mod | awk '{print $2}')
          
          # æ›´æ–° version.go
          if [ -f "version.go" ]; then
            sed -i "s/const Version = \".*\"/const Version = \"$VERSION_WITHOUT_V\"/" version.go
            git add version.go
          fi
          
          # æ›´æ–° README.md
          if [ -f "README.md" ] && grep -q "go get" README.md 2>/dev/null; then
            sed -i "s|go get $MODULE_NAME@v[0-9]*\.[0-9]*\.[0-9]*|go get $MODULE_NAME@$VERSION|g" README.md
            git add README.md
          fi
          
          # æäº¤ç‰ˆæœ¬æ›´æ–°
          if ! git diff-index --quiet HEAD --; then
            git commit -m "chore: bump version to $VERSION [skip ci]"
            git push origin ${{ github.ref_name }}
          fi
          
      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        id: changelog
        if: steps.check_release.outputs.should_release == 'true'
        run: |
          VERSION="${{ steps.new_version.outputs.version }}"
          LATEST_VERSION=$(git tag -l | grep "^v" | sort -V | tail -1)
          
          # ç”Ÿæˆå˜æ›´æ—¥å¿—
          echo "## $VERSION ($(date +%Y-%m-%d))" > changelog.md
          echo "" >> changelog.md
          
          # è·å– commit ä¿¡æ¯
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "$COMMIT_MSG" >> changelog.md
          echo "" >> changelog.md
          
          # æ·»åŠ æäº¤è®°å½•
          if [ -n "$LATEST_VERSION" ]; then
            echo "### æäº¤è®°å½•:" >> changelog.md
            git log --oneline "$LATEST_VERSION"..HEAD >> changelog.md
          else
            echo "### æäº¤è®°å½• (é¦–æ¬¡å‘å¸ƒ):" >> changelog.md
            git log --oneline --max-count=10 >> changelog.md
          fi
          
          # è¾“å‡ºå˜æ›´æ—¥å¿—å†…å®¹ä¾›åç»­ä½¿ç”¨
          CHANGELOG_CONTENT=$(cat changelog.md)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: åˆ›å»º Git æ ‡ç­¾
        if: steps.check_release.outputs.should_release == 'true'
        run: |
          VERSION="${{ steps.new_version.outputs.version }}"
          COMMIT_MSG=$(git log -1 --pretty=%B)
          
          git tag -a "$VERSION" -m "$COMMIT_MSG"
          git push origin "$VERSION"
          
      - name: åˆ›å»º GitHub Release
        if: steps.check_release.outputs.should_release == 'true'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.new_version.outputs.version }}
          release_name: Release ${{ steps.new_version.outputs.version }}
          body: ${{ steps.changelog.outputs.content }}
          draft: false
          prerelease: false
          
      - name: å‘å¸ƒä¿¡æ¯
        if: steps.check_release.outputs.should_release == 'true'
        run: |
          VERSION="${{ steps.new_version.outputs.version }}"
          MODULE_NAME=$(grep "^module " go.mod | awk '{print $2}')
          
          echo "ğŸ‰ ç‰ˆæœ¬ $VERSION å‘å¸ƒæˆåŠŸ!"
          echo ""
          echo "å‘å¸ƒä¿¡æ¯:"
          echo "- æ¨¡å—åç§°: $MODULE_NAME"
          echo "- ç‰ˆæœ¬: $VERSION"
          echo "- æ—¶é—´: $(date)"
          echo "- åˆ†æ”¯: ${{ github.ref_name }}"
          echo "- æäº¤: $(git rev-parse --short HEAD)"
          echo ""
          echo "ä½¿ç”¨æ–¹æ³•:"
          echo "  go get $MODULE_NAME@$VERSION"